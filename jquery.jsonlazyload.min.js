// (c) 2015 Joe Ridino
(function($){'use strict';var JSONLazyLoad=function(element,options){var default_settings={behavior:{ensure_scrollbar:false,fetch_amount:10,fetch_immediate:true,initial_offset:0,loader_delay:100,scroll_threshold:1},files:{increment:1,last_offset:0,pattern:''},elements:{scroll_target:$(window),loader:null},results:{before_callback:null,fail_callback:null,item_callback:null,item_key:null},ws:{data_type:'json',limit_param:'limit',offset_param:'offset',url:''}},added_event_handlers=false,ajaxing=false,check_add_event_handlers,files_offset=0,has_scrollbar,init,jquery_element=$(element),loaded_all=false,loader_hide,loader_show,loader_timeout_id,offset=0,prev_scroll_top=0,promise=null,promise_always,promise_done,promise_fail,resize_check,scroll_check,self=this,settings=null,tear_down;this.target=function(){return jquery_element;};this.fetch_items=function(limit){if(ajaxing||loaded_all){return;}
var params={},url;if(settings.files.pattern){url=settings.files.pattern.replace('[n]',files_offset+1);}else{url=settings.ws.url;params[settings.ws.limit_param]=limit;params[settings.ws.offset_param]=offset;}
if(settings.results.before_callback){settings.results.before_callback(this,limit);}
if(settings.elements.loader){loader_timeout_id=setTimeout(loader_show,settings.behavior.loader_delay);}
ajaxing=true;promise=$.ajax({url:url,data:params,dataType:settings.ws.data_type});promise.done(promise_done);promise.fail(promise_fail);promise.always(promise_always);};this.ensure_scrollbar=function(){if(!has_scrollbar()){self.fetch_items(settings.behavior.fetch_amount);}};this.destroy=function(){tear_down();};tear_down=function(){settings.elements.scroll_target.off('scroll',scroll_check);$(window).off('resize',resize_check);if(settings.elements.loader){loader_hide();}};has_scrollbar=function(){var client_height,scroll_height;client_height=settings.elements.scroll_target.innerHeight();if($.isWindow(settings.elements.scroll_target[0])){scroll_height=$(document).height();}else{scroll_height=settings.elements.scroll_target[0].scrollHeight;}
return scroll_height>client_height;};scroll_check=function(){var threshold,needs_ajax,new_scroll_top,scroll_height;new_scroll_top=settings.elements.scroll_target.scrollTop();if(new_scroll_top>prev_scroll_top&&!(ajaxing||loaded_all)){if($.isWindow(settings.elements.scroll_target[0])){scroll_height=$(document).height();}else{scroll_height=settings.elements.scroll_target[0].scrollHeight;}
threshold=scroll_height-settings.behavior.scroll_threshold;needs_ajax=(new_scroll_top+settings.elements.scroll_target.innerHeight())>=threshold;if(needs_ajax){self.fetch_items(settings.behavior.fetch_amount);}}
prev_scroll_top=new_scroll_top;};resize_check=function(){if(ajaxing||loaded_all){return;}
if(settings.behavior.ensure_scrollbar){self.ensure_scrollbar();}};check_add_event_handlers=function(){if(!added_event_handlers){settings.elements.scroll_target.on('scroll',scroll_check);$(window).on('resize',resize_check);added_event_handlers=true;}};promise_done=function(data){var completed=false,dataEmpty=false;if(settings.results.item_key){data=data[settings.results.item_key];}
if(settings.files.pattern){completed=(files_offset===settings.files.last_offset);files_offset+=settings.files.increment;}else{if($.isArray(data)){offset+=data.length;if(data.length===0){completed=true;dataEmpty=true;}}else{offset+=1;if(data===''){completed=true;dataEmpty=true;}}}
if(!dataEmpty){settings.results.item_callback(self,data);}
if(completed){loaded_all=true;tear_down();}
check_add_event_handlers();};promise_fail=function(){if(settings.results.fail_callback){settings.results.fail_callback(self);}};promise_always=function(data,status){ajaxing=false;if(settings.elements.loader){loader_hide();}
if(!loaded_all&&status==='success'&&settings.behavior.ensure_scrollbar){self.ensure_scrollbar();}};loader_show=function(){settings.elements.loader.show();};loader_hide=function(){clearTimeout(loader_timeout_id);settings.elements.loader.hide();};init=function(){settings=$.extend(true,{},default_settings,options);offset=settings.behavior.initial_offset;files_offset=settings.behavior.initial_offset;if(settings.behavior.fetch_immediate){self.fetch_items(settings.behavior.fetch_amount);}else{check_add_event_handlers();}};init();};$.fn.jsonlazyload=function(options){return this.each(function(){var jsonlazyload=new JSONLazyLoad(this,options);$(this).data('jsonlazyload',jsonlazyload);});};}(jQuery));